<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Live Viewer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: white;
      display: flex;
      flex-direction: column;
    }
    header {
      background: rgba(0,0,0,0.3);
      padding: 20px;
      text-align: center;
    }
    h1 { font-size: 2rem; margin-bottom: 10px; }
    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      background: rgba(255,255,255,0.2);
      border-radius: 20px;
      font-size: 0.85rem;
    }
    .status-badge.online { background: rgba(16, 185, 129, 0.5); }
    main {
      flex: 1;
      padding: 30px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }
    .qr-display {
      background: rgba(255,255,255,0.15);
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      backdrop-filter: blur(15px);
      margin-bottom: 30px;
    }
    .waiting-msg {
      font-size: 1.8rem;
      opacity: 0.7;
      padding: 50px;
    }
    .qr-content { display: none; }
    .qr-content.active { display: block; }
    #qr-img {
      display: block;
      margin: 20px auto;
      background: white;
      padding: 25px;
      border-radius: 15px;
      max-width: 350px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    .qr-text {
      background: rgba(0,0,0,0.4);
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      word-wrap: break-word;
      font-family: 'Courier New', monospace;
      font-size: 1.05rem;
    }
    .qr-metadata {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    .meta-badge {
      background: rgba(255,255,255,0.15);
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 0.95rem;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: rgba(255,255,255,0.15);
      padding: 25px;
      border-radius: 15px;
      text-align: center;
    }
    .stat-number {
      font-size: 3rem;
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }
    .stat-label {
      opacity: 0.85;
      font-size: 0.95rem;
    }
    .history-section {
      background: rgba(255,255,255,0.15);
      padding: 25px;
      border-radius: 15px;
      max-height: 350px;
      overflow-y: auto;
    }
    .history-section h2 {
      margin-bottom: 20px;
      font-size: 1.4rem;
    }
    .history-entry {
      background: rgba(0,0,0,0.25);
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
      font-size: 0.9rem;
    }
    .back-link {
      display: inline-block;
      margin-top: 25px;
      padding: 12px 25px;
      background: rgba(255,255,255,0.2);
      color: white;
      text-decoration: none;
      border-radius: 10px;
      transition: all 0.3s;
    }
    .back-link:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .animate-in { animation: fadeIn 0.5s ease; }
  </style>
</head>
<body>
  <header>
    <h1>üëÅÔ∏è QR Code Viewer - Live</h1>
    <span class="status-badge" id="status">‚è≥ Connexion...</span>
  </header>

  <main>
    <div class="qr-display">
      <div class="waiting-msg" id="waiting">
        üéØ En attente d'un scan...
      </div>
      <div class="qr-content" id="content">
        <h2>üì± QR Code Re√ßu</h2>
        <img id="qr-img" alt="QR Code">
        <div class="qr-text" id="qr-text"></div>
        <div class="qr-metadata">
          <div class="meta-badge">
            üïí <strong id="qr-time">--:--</strong>
          </div>
          <div class="meta-badge">
            #Ô∏è‚É£ Scan <strong id="qr-num">-</strong>
          </div>
        </div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-number" id="total">0</span>
        <span class="stat-label">Total Scans</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="viewers">0</span>
        <span class="stat-label">Viewers</span>
      </div>
    </div>

    <div class="history-section">
      <h2>üìú Historique</h2>
      <div id="history">
        <div style="text-align:center;opacity:0.6;">Aucun scan</div>
      </div>
    </div>

    <a href="/" class="back-link">‚Üê Accueil</a>
  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ===== NOUVELLE VERSION COMPLETE =====
    const ws = io();
    const historyData = [];
    const MAX_HISTORY = 25;

    // Connexion
    ws.on('connect', () => {
      document.getElementById('status').textContent = 'üü¢ Connect√©';
      document.getElementById('status').classList.add('online');
    });

    ws.on('disconnect', () => {
      document.getElementById('status').textContent = 'üî¥ D√©connect√©';
      document.getElementById('status').classList.remove('online');
    });

    // Stats
    ws.on('stats-update', (s) => {
      document.getElementById('total').textContent = s.scanCount;
      document.getElementById('viewers').textContent = s.connectedClients;
    });

    // QR re√ßu
    ws.on('qr-live', (d) => {
      console.log('‚úÖ QR re√ßu:', d);
      showQR(d);
      saveHistory(d);
    });

    function showQR(data) {
      document.getElementById('waiting').style.display = 'none';

      const content = document.getElementById('content');
      content.classList.add('active');
      content.classList.add('animate-in');

      // G√©n√©rer QR via API
      const encoded = encodeURIComponent(data.value);
      const img = document.getElementById('qr-img');
      img.src = `https://api.qrserver.com/v1/create-qr-code/?size=350x350&data=${encoded}`;
      img.style.display = 'block';

      // Texte et metadata
      document.getElementById('qr-text').textContent = data.value;
      document.getElementById('qr-time').textContent = new Date(data.timestamp).toLocaleTimeString();
      document.getElementById('qr-num').textContent = data.scanNumber || '-';
    }

    function saveHistory(data) {
      historyData.unshift(data);
      if (historyData.length > MAX_HISTORY) historyData.pop();

      const html = historyData.map((item, i) => `
        <div class="history-entry">
          <strong>#${item.scanNumber || (historyData.length - i)}</strong> -
          ${new Date(item.timestamp).toLocaleString()} -
          <code>${item.value.substring(0, 60)}${item.value.length > 60 ? '...' : ''}</code>
        </div>
      `).join('');

      document.getElementById('history').innerHTML = html;
    }
  </script>
</body>
</html>
